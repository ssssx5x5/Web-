<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkBucket Â· ÄÄƒng nháº­p</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; box-sizing: border-box; }
        body { background: #eef2f6; display: flex; justify-content: center; padding: 2rem; }
        .container { max-width: 600px; width: 100%; background: white; border-radius: 2rem; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { color: #1e3c5c; }
        .card { background: #f8fafd; border-radius: 1.5rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        input { width: 100%; padding: 0.8rem; margin: 0.5rem 0 1rem; border: 1px solid #ccc; border-radius: 2rem; }
        button { background: #1e3c5c; color: white; border: none; padding: 0.8rem 2rem; border-radius: 2rem; font-weight: bold; cursor: pointer; }
        button:hover { background: #2b5b8b; }
        .message { padding: 0.5rem; border-radius: 1rem; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .hidden { display: none; }
        #userPanel { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        #logoutBtn { background: #b54a4a; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ”— LinkBucket</h1>

    <!-- Panel ngÆ°á»i dÃ¹ng (chá»‰ hiá»‡n khi Ä‘Ã£ Ä‘Äƒng nháº­p) -->
    <div id="userPanel" class="hidden">
        <span><strong id="welcomeUser"></strong></span>
        <button id="logoutBtn">ÄÄƒng xuáº¥t</button>
    </div>

    <!-- Form Ä‘Äƒng kÃ½ & Ä‘Äƒng nháº­p (chá»‰ hiá»‡n khi chÆ°a Ä‘Äƒng nháº­p) -->
    <div id="authForms">
        <div class="card">
            <h2>ğŸ“ ÄÄƒng kÃ½</h2>
            <input type="text" id="regUser" placeholder="TÃªn ngÆ°á»i dÃ¹ng">
            <input type="password" id="regPass" placeholder="Máº­t kháº©u">
            <button id="registerBtn">ÄÄƒng kÃ½</button>
            <div id="registerMsg" class="message"></div>
        </div>
        <div class="card">
            <h2>ğŸ” ÄÄƒng nháº­p</h2>
            <input type="text" id="loginUser" placeholder="TÃªn ngÆ°á»i dÃ¹ng">
            <input type="password" id="loginPass" placeholder="Máº­t kháº©u">
            <button id="loginBtn">ÄÄƒng nháº­p</button>
            <div id="loginMsg" class="message"></div>
        </div>
    </div>

    <!-- Form Ä‘Äƒng link (chá»‰ hiá»‡n khi Ä‘Ã£ Ä‘Äƒng nháº­p) -->
    <div id="postSection" class="card hidden">
        <h2>â• ÄÄƒng link má»›i</h2>
        <input type="text" id="linkTitle" maxlength="50" placeholder="TiÃªu Ä‘á» (tá»‘i Ä‘a 50 kÃ½ tá»±)">
        <input type="url" id="linkUrl" placeholder="https://...">
        <button id="addLinkBtn">Gá»­i link</button>
        <div id="linkMsg" class="message"></div>
    </div>

    <!-- TÃ¬m kiáº¿m -->
    <div class="card">
        <h2>ğŸ” TÃ¬m kiáº¿m</h2>
        <input type="text" id="searchInput" placeholder="Nháº­p tá»« khÃ³a...">
        <div id="results"></div>
    </div>
</div>

<script>
    // --- Xá»­ lÃ½ localStorage ---
    let token = localStorage.getItem('token');
    let username = localStorage.getItem('username');

    const authForms = document.getElementById('authForms');
    const postSection = document.getElementById('postSection');
    const userPanel = document.getElementById('userPanel');
    const welcomeUser = document.getElementById('welcomeUser');

    function showMessage(el, msg, isSuccess) {
        el.textContent = msg;
        el.className = 'message ' + (isSuccess ? 'success' : 'error');
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 3000);
    }

    function updateUI() {
        if (token && username) {
            authForms.classList.add('hidden');
            postSection.classList.remove('hidden');
            userPanel.classList.remove('hidden');
            welcomeUser.textContent = `Xin chÃ o, ${username}!`;
        } else {
            authForms.classList.remove('hidden');
            postSection.classList.add('hidden');
            userPanel.classList.add('hidden');
        }
    }

    // ÄÄƒng xuáº¥t
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('token');
        localStorage.removeItem('username');
        token = null;
        username = null;
        updateUI();
    });

    // ÄÄƒng kÃ½
    document.getElementById('registerBtn').addEventListener('click', async () => {
        const user = document.getElementById('regUser').value.trim();
        const pass = document.getElementById('regPass').value.trim();
        if (!user || !pass) return showMessage(document.getElementById('registerMsg'), 'Nháº­p Ä‘áº§y Ä‘á»§', false);
        const res = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user, pass})
        });
        const data = await res.json();
        showMessage(document.getElementById('registerMsg'), data.msg, data.success);
        if (data.success) {
            document.getElementById('regUser').value = '';
            document.getElementById('regPass').value = '';
        }
    });

    // ÄÄƒng nháº­p
    document.getElementById('loginBtn').addEventListener('click', async () => {
        const user = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value.trim();
        if (!user || !pass) return showMessage(document.getElementById('loginMsg'), 'Nháº­p Ä‘áº§y Ä‘á»§', false);
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({user, pass})
        });
        const data = await res.json();
        if (data.success) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('username', data.user);
            token = data.token;
            username = data.user;
            updateUI();
            showMessage(document.getElementById('loginMsg'), 'ÄÄƒng nháº­p thÃ nh cÃ´ng!', true);
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
        } else {
            showMessage(document.getElementById('loginMsg'), data.msg, false);
        }
    });

    // ÄÄƒng link
    document.getElementById('addLinkBtn').addEventListener('click', async () => {
        if (!token) return showMessage(document.getElementById('linkMsg'), 'Báº¡n chÆ°a Ä‘Äƒng nháº­p', false);
        const title = document.getElementById('linkTitle').value.trim();
        const url = document.getElementById('linkUrl').value.trim();
        if (!title || !url) return showMessage(document.getElementById('linkMsg'), 'Thiáº¿u thÃ´ng tin', false);
        if (title.length > 50) return showMessage(document.getElementById('linkMsg'), 'TiÃªu Ä‘á» quÃ¡ dÃ i', false);
        const res = await fetch('/api/add-link', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, url, token})
        });
        const data = await res.json();
        showMessage(document.getElementById('linkMsg'), data.msg, data.success);
        if (data.success) {
            document.getElementById('linkTitle').value = '';
            document.getElementById('linkUrl').value = '';
            // Tá»± Ä‘á»™ng tÃ¬m kiáº¿m láº¡i (náº¿u muá»‘n)
            search();
        } else if (data.msg.includes('Ä‘Äƒng nháº­p')) {
            // Token háº¿t háº¡n
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            token = null;
            username = null;
            updateUI();
        }
    });

    // TÃ¬m kiáº¿m
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('results');

    async function search() {
        const keyword = searchInput.value.trim();
        const res = await fetch(`/api/search?k=${encodeURIComponent(keyword)}`);
        const links = await res.json();
        if (links.length === 0) {
            resultsDiv.innerHTML = '<p>KhÃ´ng cÃ³ link nÃ o.</p>';
        } else {
            let html = '';
            links.forEach(l => {
                html += `<div style="border-bottom:1px solid #ccc; padding:0.5rem 0">
                    <strong>${l.title}</strong><br>
                    <a href="${l.url}" target="_blank">${l.url}</a><br>
                    <small>${l.date}</small>
                </div>`;
            });
            resultsDiv.innerHTML = html;
        }
    }
    searchInput.addEventListener('input', search);

    // Khá»Ÿi táº¡o
    updateUI();
    search(); // hiá»ƒn thá»‹ táº¥t cáº£ link khi load
</script>
</body>
</html>
